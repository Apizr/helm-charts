suite: Test that API is well configured with custom home directory
templates:
  - "api/api-deployment.yaml"
  - "api/api-configmap.yaml"

tests:
  - it: Set API home properly
    template: api/api-deployment.yaml
    set:
        graviteeHomeRoot: /custom-root
        management:
          type: jdbc
        jdbc:
          url: jdbc:mysql://localhost:3306/gravitee
          driver: https://repo1.maven.org/maven2/mysql/mysql-connector-java/8.0.22/mysql-connector-java-8.0.22.jar
        api:
            homePath: /custom-graviteeio-api
            logging:
              debug: true
            additionalPlugins:
              - https://download.gravitee.io/aplugin.zip
        cockpit:
            enabled: true
            keystore:
              value: "base64 encoded value of the keystore provided by Cockpit (required)"
              password:
                value: "keystores password provided by Cockpit"
            truststore:
              value: "base64 encoded value of the truststore provided by Cockpit (required)"
              password:
                value: "truststore password provided by Cockpit"
            url: https://cockpit.gravitee.io
            controller: https://cockpit-controller.gravitee.io
            ssl:
              verifyHostname: true
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Deployment
      - equal:
          path: spec.template.spec.containers[0].volumeMounts
          value:
            - name: config
              mountPath: /custom-root/custom-graviteeio-api/config/gravitee.yml
              subPath: gravitee.yml
            - name: config
              mountPath: /custom-root/custom-graviteeio-api/config/logback.xml
              subPath: logback.xml
            - name: graviteeio-apim-repository-jdbc-ext
              mountPath: /custom-root/custom-graviteeio-api/plugins/ext/repository-jdbc
            - name: gravitee-cockpit-certificates
              mountPath: /custom-root/custom-graviteeio-api/cockpit
              readOnly: true
            - name: graviteeio-apim-plugins
              mountPath: /custom-root/custom-graviteeio-api/plugins-ext

      - equal:
          path: spec.template.spec.containers[0].env[0]
          value:
            name: GRAVITEE_PLUGINS_PATH_0
            value: '${gravitee.home}/plugins'
      - equal:
          path: spec.template.spec.containers[0].env[1]
          value:
            name: GRAVITEE_PLUGINS_PATH_1
            value: '${gravitee.home}/plugins-ext'
      - equal:
          path: spec.template.spec.containers[0].env[6]
          value:
            name: gravitee_cockpit_keystore_path
            value: /custom-root/custom-graviteeio-api/cockpit/keystore.p12
      - equal:
          path: spec.template.spec.containers[0].env[9]
          value:
            name: gravitee_cockpit_truststore_path
            value: /custom-root/custom-graviteeio-api/cockpit/truststore.p12
